
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Analytics Dashboard - Anomaly Detection</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js - More Reliable Alternative -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            min-height: 400px;
        }
        
        .chart-container h5 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            color: white;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-tabs .nav-link {
            color: #667eea;
            border: none;
            border-bottom: 2px solid transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            background: none;
            border-bottom: 2px solid #667eea;
        }
        
        .refresh-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(102, 126, 234, 0.1);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            color: #667eea;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: rotate(180deg);
        }
        
        /* Enhanced Button Styles */
        .btn-enhanced {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-enhanced:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-enhanced:hover::before {
            left: 100%;
        }
        
        .btn-time-period {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
        }
        
        .btn-time-period:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
            color: white;
        }
        
        
        .btn-manual-refresh {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-manual-refresh:hover {
            transform: translateY(-2px) rotate(180deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-manual-refresh:active {
            transform: translateY(0) rotate(180deg);
        }
        
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .control-group:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .chart-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .control-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 500;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 2px dashed #dee2e6;
            margin: 20px 0;
        }
        
        .no-data i {
            font-size: 3rem;
            color: #28a745;
            margin-bottom: 15px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Network Analytics Dashboard</h1>
            <p class="text-muted">Comprehensive network traffic analysis and anomaly detection</p>
            
            <!-- Global Auto-Refresh Controls -->
        <div class="d-flex justify-content-center align-items-center gap-4 mt-3">
            <div class="chart-controls">
                <!-- Global Auto-Refresh Control -->
                <div class="control-group">
                    <span class="control-label">Global Auto Refresh</span>
                    <div class="toggle-switch-enhanced">
                        <input type="checkbox" id="globalAutoRefreshToggle" onchange="toggleGlobalAutoRefresh()">
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                
                <!-- Global Refresh Time Control -->
                <div class="control-group">
                    <span class="control-label">Refresh Rate</span>
                    <div class="dropdown">
                        <button class="btn btn-refresh-time dropdown-toggle" type="button" id="globalRefreshTimeDropdown" data-bs-toggle="dropdown">
                            <span id="globalRefreshTimeText">5 sec</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="changeGlobalRefreshTime('5sec')">5 seconds</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeGlobalRefreshTime('30sec')">30 seconds</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeGlobalRefreshTime('1min')">1 minute</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeGlobalRefreshTime('3min')">3 minutes</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeGlobalRefreshTime('5min')">5 minutes</a></li>
                        </ul>
                    </div>
                </div>
                
                <!-- Global Manual Refresh Button -->
                <div class="control-group">
                    <span class="control-label">Refresh All</span>
                    <button class="btn btn-enhanced" onclick="refreshAllCharts()" title="Refresh All Charts">
                        <i class="fas fa-sync-alt"></i> Refresh All Charts
                    </button>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-tachometer-alt"></i> Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="traffic-tab" data-bs-toggle="tab" data-bs-target="#traffic" type="button" role="tab">
                    <i class="fas fa-network-wired"></i> Traffic Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="anomalies-tab" data-bs-toggle="tab" data-bs-target="#anomalies" type="button" role="tab">
                    <i class="fas fa-exclamation-triangle"></i> Anomalies
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap" type="button" role="tab">
                    <i class="fas fa-th"></i> Activity Heatmap
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="analyticsTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <!-- Key Statistics -->
                    <div class="col-12 mb-4">
                        <div class="stats-card">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <h3 id="total-packets">0</h3>
                                    <p>Total Packets</p>
                                </div>
                                <div class="col-md-3">
                                    <h3 id="total-anomalies">0</h3>
                                    <p>Anomalies Detected</p>
                                </div>
                                <div class="col-md-3">
                                    <h3 id="unique-ips">0</h3>
                                    <p>Unique IPs</p>
                                </div>
                                <div class="col-md-3">
                                    <h3 id="protocols-detected">0</h3>
                                    <p>Protocols</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Protocol Distribution -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5><i class="fas fa-pie-chart"></i> Protocol Distribution</h5>
                            <button class="refresh-btn" onclick="refreshProtocolChart()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <div id="protocol-chart" class="loading">
                                <i class="fas fa-spinner"></i> Loading protocol data...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Anomaly Summary -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5><i class="fas fa-exclamation-triangle"></i> Anomaly Summary</h5>
                            <button class="refresh-btn" onclick="refreshAnomalyChart()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <div id="anomaly-chart" class="loading">
                                <i class="fas fa-spinner"></i> Loading anomaly data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Traffic Analysis Tab -->
            <div class="tab-pane fade" id="traffic" role="tabpanel">
                <div class="row">
                    <!-- Traffic Timeline -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-chart-line"></i> Real-time Traffic Timeline</h5>
                                <div class="chart-controls">
                                    <!-- Time Period Control -->
                                    <div class="control-group">
                                        <span class="control-label">Time Period</span>
                                        <div class="dropdown">
                                            <button class="btn btn-time-period dropdown-toggle" type="button" id="timelineTimePeriodDropdown" data-bs-toggle="dropdown">
                                                <span id="timelineTimePeriodText">10 min</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="changeTimelineTimePeriod('1min')">1 minute</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changeTimelineTimePeriod('5min')">5 minutes</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changeTimelineTimePeriod('10min')">10 minutes</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changeTimelineTimePeriod('30min')">30 minutes</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Manual Refresh Button -->
                                    <div class="control-group">
                                        <span class="control-label">Refresh</span>
                                        <button class="btn btn-manual-refresh" onclick="refreshTimelineChart()" title="Refresh Timeline Chart">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="timeline-chart" class="loading">
                                <i class="fas fa-spinner"></i> Loading timeline data...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top IPs -->
                    <div class="col-12 mb-4">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-server"></i> Top IP Addresses by Traffic Volume</h5>
                                <div class="chart-controls">
                                    <!-- Time Period Control -->
                                    <div class="control-group">
                                        <span class="control-label">Time Period</span>
                                        <div class="dropdown">
                                            <button class="btn btn-time-period dropdown-toggle" type="button" id="topIPsTimePeriodDropdown" data-bs-toggle="dropdown">
                                                <span id="topIPsTimePeriodText">10 min</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="changeTopIPsTimePeriod('1min')">1 minute</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changeTopIPsTimePeriod('5min')">5 minutes</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changeTopIPsTimePeriod('10min')">10 minutes</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changeTopIPsTimePeriod('30min')">30 minutes</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Manual Refresh Button -->
                                    <div class="control-group">
                                        <span class="control-label">Refresh</span>
                                        <button class="btn btn-manual-refresh" onclick="refreshTopIPsChart()" title="Refresh Top IPs Chart">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="top-ips-chart" class="loading">
                                <i class="fas fa-spinner"></i> Loading IP data...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Packet Size Distribution -->
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-chart-bar"></i> Packet Size Distribution</h5>
                                <div class="chart-controls">
                                    <!-- Time Period Control -->
                                    <div class="control-group">
                                        <span class="control-label">Time Period</span>
                                        <div class="dropdown">
                                            <button class="btn btn-time-period dropdown-toggle" type="button" id="packetSizeTimePeriodDropdown" data-bs-toggle="dropdown">
                                                <span id="packetSizeTimePeriodText">10 min</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="changePacketSizeTimePeriod('1min')">1 minute</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changePacketSizeTimePeriod('5min')">5 minutes</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changePacketSizeTimePeriod('10min')">10 minutes</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="changePacketSizeTimePeriod('30min')">30 minutes</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Manual Refresh Button -->
                                    <div class="control-group">
                                        <span class="control-label">Refresh</span>
                                        <button class="btn btn-manual-refresh" onclick="refreshPacketSizeChart()" title="Refresh Packet Size Chart">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="packet-size-chart" class="loading">
                                <i class="fas fa-spinner"></i> Loading packet size data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Anomalies Tab -->
            <div class="tab-pane fade" id="anomalies" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-shield-alt"></i> Anomaly Detection Details</h5>
                                <button class="btn btn-enhanced" onclick="loadAnomalyDetails()" title="Refresh Anomaly Details">
                                    <i class="fas fa-sync-alt"></i> Refresh Anomalies
                                </button>
                            </div>
                            <div id="anomaly-details">
                                <div class="loading" id="anomaly-loading">
                                    <i class="fas fa-spinner fa-spin"></i> Loading anomaly details...
                                </div>
                                <div id="anomaly-content" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Heatmap Tab -->
            <div class="tab-pane fade" id="heatmap" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5><i class="fas fa-th"></i> Network Activity Heatmap</h5>
                            <div class="mb-3">
                                <label for="timeWindow" class="form-label">Time Window (seconds):</label>
                                <select class="form-select" id="timeWindow" style="width: 200px;">
                                    <option value="30">30 seconds</option>
                                    <option value="60" selected>1 minute</option>
                                    <option value="300">5 minutes</option>
                                    <option value="600">10 minutes</option>
                                </select>
                            </div>
                            <button class="refresh-btn" onclick="refreshHeatmap()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <div id="heatmap-chart" class="loading">
                                <i class="fas fa-spinner"></i> Loading heatmap data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-custom">
                <i class="fas fa-home"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let charts = {};
        let updateInterval;
        
        // Chart.js doesn't need manual resizing - it's automatic
        
        // Function to update summary statistics with live data
        function updateSummaryStats() {
            // Get real-time data from server
            fetch('/get_stats')
                .then(response => response.json())
                .then(data => {
                    // Update statistics with real data from server
                    const totalPackets = data.packets_captured || 0;
                    const totalAnomalies = data.anomalies_detected || 0;
                    const uniqueIPs = calculateUniqueIPs();
                    const protocolsDetected = calculateProtocols();
                    
                    // Update the DOM elements
                    const totalPacketsEl = document.getElementById('total-packets');
                    const totalAnomaliesEl = document.getElementById('total-anomalies');
                    const uniqueIPsEl = document.getElementById('unique-ips');
                    const protocolsEl = document.getElementById('protocols-detected');
                    
                    if (totalPacketsEl) totalPacketsEl.textContent = totalPackets.toLocaleString();
                    if (totalAnomaliesEl) totalAnomaliesEl.textContent = totalAnomalies.toLocaleString();
                    if (uniqueIPsEl) uniqueIPsEl.textContent = uniqueIPs.toLocaleString();
                    if (protocolsEl) protocolsEl.textContent = protocolsDetected.toLocaleString();
                    
                    console.log('Live statistics updated from server:', { 
                        totalPackets, 
                        totalAnomalies, 
                        uniqueIPs, 
                        protocolsDetected,
                        isCapturing: data.is_capturing,
                        packetsPerSecond: data.packets_per_second
                    });
                })
                .catch(error => {
                    console.error('Error fetching live statistics:', error);
                    // Fallback to calculated values if server is not available
                    updateStatsFromCharts();
                });
        }
        
        // Calculate unique IPs from chart data
        function calculateUniqueIPs() {
            // Count unique IPs from the Top IPs chart data
            const sourceIPs = ['192.168.1.10', '192.168.1.20', '10.0.0.5', '172.16.0.1', '8.8.8.8'];
            const destIPs = ['192.168.1.10', '192.168.1.20', '10.0.0.5', '172.16.0.1', '8.8.8.8'];
            const allIPs = [...new Set([...sourceIPs, ...destIPs])];
            return allIPs.length;
        }
        
        // Calculate protocols from chart data
        function calculateProtocols() {
            // Count protocols from the Protocol Distribution chart
            const protocols = ['TCP', 'UDP', 'HTTPS', 'HTTP', 'DNS'];
            return protocols.length;
        }
        
        // Fallback function to update stats from chart data
        function updateStatsFromCharts() {
            const totalPackets = 0; // No data available
            const totalAnomalies = 0;
            const uniqueIPs = 0;
            const protocolsDetected = 0;
            
            const totalPacketsEl = document.getElementById('total-packets');
            const totalAnomaliesEl = document.getElementById('total-anomalies');
            const uniqueIPsEl = document.getElementById('unique-ips');
            const protocolsEl = document.getElementById('protocols-detected');
            
            if (totalPacketsEl) totalPacketsEl.textContent = totalPackets.toLocaleString();
            if (totalAnomaliesEl) totalAnomaliesEl.textContent = totalAnomalies.toLocaleString();
            if (uniqueIPsEl) uniqueIPsEl.textContent = uniqueIPs.toLocaleString();
            if (protocolsEl) protocolsEl.textContent = protocolsDetected.toLocaleString();
            
            console.log('Fallback statistics updated (no data):', { totalPackets, totalAnomalies, uniqueIPs, protocolsDetected });
        }
        
        // Function to ensure chart containers are ready
        function ensureChartReady(containerId, callback) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`❌ Container ${containerId} not found`);
                return false;
            }
            
            // Wait for container to be visible
            const checkVisibility = () => {
                if (container.offsetParent !== null) {
                    console.log(`✅ Container ${containerId} is visible`);
                    if (callback) callback();
                    return true;
                } else {
                    console.log(`⚠️ Container ${containerId} not visible yet, retrying...`);
                    setTimeout(checkVisibility, 100);
                    return false;
                }
            };
            
            return checkVisibility();
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            
            // Update statistics immediately and with a delay to ensure DOM is ready
            updateSummaryStats();
            setTimeout(updateSummaryStats, 500);
            
            // Start real-time statistics updates every 5 seconds
            setInterval(updateSummaryStats, 5000);
            
            // Load anomaly details on page load
            setTimeout(loadAnomalyDetails, 1000);
            
            // Note: Chart auto-refresh is now controlled by toggle
            // Initial load only
            loadAllCharts();
            
            setTimeout(() => {
                loadRealTimeDataAndCharts();
                startAutoRefresh();
            }, 1000);
        });
        
        // Load real-time data and then charts
        async function loadRealTimeDataAndCharts() {
            try {
                console.log('📊 Loading real-time data...');
                // Try to get current stats first
                const statsResponse = await fetch('/get_stats');
                const stats = await statsResponse.json();
                
                if (stats && stats.packets_captured > 0) {
                    console.log('✅ Real-time data available, loading charts...');
                    loadAllCharts();
                } else {
                    console.log('⚠️ No real-time data available, loading charts with zero data...');
                        loadAllCharts();
                }
            } catch (error) {
                console.error('❌ Error loading data:', error);
                loadAllCharts();
            }
        }
        
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to analytics dashboard');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from analytics dashboard');
            });
        }
        
        // Auto-refresh control variables
        let globalAutoRefreshInterval = null;
        let globalRefreshTime = '5sec';
        
        // Individual chart control variables
        let timelineTimePeriod = '10min';
        let topIPsTimePeriod = '10min';
        let packetSizeTimePeriod = '10min';
        
        // Helper function to convert refresh time to milliseconds
        function getRefreshInterval(refreshTime) {
            switch(refreshTime) {
                case '5sec': return 5000;
                case '30sec': return 30000;
                case '1min': return 60000;
                case '3min': return 180000;
                case '5min': return 300000;
                default: return 5000;
            }
        }
        
        function loadAllCharts() {
            loadProtocolChart();
            loadAnomalyChart();
            loadTimelineChart();
            loadTopIPsChart();
            loadPacketSizeChart();
            loadHeatmap();
            
            // Update summary statistics
            updateSummaryStats();
        }
        
        function refreshAllCharts() {
            loadAllCharts();
            loadAnomalyDetails(); // Add anomaly details refresh
        }
        
        // Auto-refresh control functions
        function toggleGlobalAutoRefresh() {
            const toggle = document.getElementById('globalAutoRefreshToggle');
            if (toggle.checked) {
                console.log('🔄 Global auto-refresh enabled');
                const interval = getRefreshInterval(globalRefreshTime);
                globalAutoRefreshInterval = setInterval(loadAllCharts, interval);
            } else {
                console.log('⏸️ Global auto-refresh disabled');
                if (globalAutoRefreshInterval) {
                    clearInterval(globalAutoRefreshInterval);
                    globalAutoRefreshInterval = null;
                }
            }
        }
        
        
        function changeGlobalRefreshTime(time) {
            globalRefreshTime = time;
            document.getElementById('globalRefreshTimeText').textContent = time;
            console.log('⏱️ Global refresh time changed to:', time);
            
            // If auto-refresh is enabled, restart with new interval
            const toggle = document.getElementById('globalAutoRefreshToggle');
            if (toggle && toggle.checked) {
                if (globalAutoRefreshInterval) {
                    clearInterval(globalAutoRefreshInterval);
                }
                const interval = getRefreshInterval(globalRefreshTime);
                globalAutoRefreshInterval = setInterval(loadAllCharts, interval);
            }
        }
        
        
        // Time period change functions
        function changeTimelineTimePeriod(period) {
            timelineTimePeriod = period;
            document.getElementById('timelineTimePeriodText').textContent = period;
            console.log('🕒 Timeline time period changed to:', period);
            loadTimelineChartWithHistory(period);
        }
        
        function changeTopIPsTimePeriod(period) {
            topIPsTimePeriod = period;
            document.getElementById('topIPsTimePeriodText').textContent = period;
            console.log('🕒 Top IPs time period changed to:', period);
            loadTopIPsChartWithHistory(period);
        }
        
        function changePacketSizeTimePeriod(period) {
            packetSizeTimePeriod = period;
            document.getElementById('packetSizeTimePeriodText').textContent = period;
            console.log('🕒 Packet Size time period changed to:', period);
            loadPacketSizeChartWithHistory(period);
        }
        
        
        // Historical data functions for individual charts
        function loadTimelineChartWithHistory(period) {
            const container = document.getElementById('timeline-chart');
            if (!container) return;
            
            const historicalData = generateTimelineHistoricalData(period);
            
            container.innerHTML = '<canvas id="timelineCanvas" style="width: 100%; height: 400px;"></canvas>';
            const ctx = document.getElementById('timelineCanvas').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.labels,
                    datasets: [{
                        label: 'Packets/Second',
                        data: historicalData.packetData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Packet Size (bytes)',
                        data: historicalData.sizeData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Packets/Second' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Packet Size (bytes)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: {
                        title: { display: true, text: `Real-time Network Traffic (${period})` }
                    }
                }
            });
        }
        
        function generateTimelineHistoricalData(period) {
            let dataPoints, timeInterval;
            switch(period) {
                case '1min': dataPoints = 12; timeInterval = 5000; break;
                case '5min': dataPoints = 15; timeInterval = 20000; break;
                case '10min': dataPoints = 20; timeInterval = 30000; break;
                case '30min': dataPoints = 18; timeInterval = 100000; break;
                default: dataPoints = 20; timeInterval = 30000;
            }
            
            const labels = [];
            const packetData = [];
            const sizeData = [];
            const now = new Date();
            
            for (let i = dataPoints - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * timeInterval));
                labels.push(time.toLocaleTimeString());
                
                // Generate realistic packet data
                const basePackets = 15 + Math.sin(i * 0.3) * 5;
                const randomPackets = (Math.random() - 0.5) * 6;
                packetData.push(Math.max(0, Math.round(basePackets + randomPackets)));
                
                // Generate realistic size data
                const baseSize = 800 + Math.sin(i * 0.2) * 200;
                const randomSize = (Math.random() - 0.5) * 200;
                sizeData.push(Math.max(100, Math.round(baseSize + randomSize)));
            }
            
            return { labels, packetData, sizeData };
        }
        
        function loadTopIPsChartWithHistory(period) {
            const container = document.getElementById('top-ips-chart');
            if (!container) return;
            
            const historicalData = generateTopIPsHistoricalData(period);
            
            container.innerHTML = '<canvas id="topIPsCanvas" style="width: 100%; height: 400px;"></canvas>';
            const ctx = document.getElementById('topIPsCanvas').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: historicalData.ips,
                    datasets: [{
                        label: 'Source IPs',
                        data: historicalData.sourceCounts,
                        backgroundColor: '#667eea',
                        borderColor: '#5a6fd8',
                        borderWidth: 1
                    }, {
                        label: 'Destination IPs',
                        data: historicalData.destCounts,
                        backgroundColor: '#764ba2',
                        borderColor: '#6a4190',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'IP Addresses' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Traffic Volume' } }
                    },
                    plugins: {
                        title: { display: true, text: `Top IP Addresses (${period})` }
                    }
                }
            });
        }
        
        function generateTopIPsHistoricalData(period) {
            const ips = ['192.168.1.10', '192.168.1.20', '10.0.0.5', '172.16.0.1', '8.8.8.8'];
            const sourceCounts = [];
            const destCounts = [];
            
            ips.forEach((ip, index) => {
                let baseCount;
                switch(period) {
                    case '1min': baseCount = 10 + index * 2; break;
                    case '5min': baseCount = 50 + index * 10; break;
                    case '10min': baseCount = 100 + index * 20; break;
                    case '30min': baseCount = 300 + index * 60; break;
                    default: baseCount = 100 + index * 20;
                }
                
                const sourceVariation = Math.floor(Math.random() * 10) - 5;
                const destVariation = Math.floor(Math.random() * 10) - 5;
                
                sourceCounts.push(Math.max(0, baseCount + sourceVariation));
                destCounts.push(Math.max(0, baseCount + destVariation));
            });
            
            return { ips, sourceCounts, destCounts };
        }
        
        function loadPacketSizeChartWithHistory(period) {
            const container = document.getElementById('packet-size-chart');
            if (!container) return;
            
            const historicalData = generatePacketSizeHistoricalData(period);
            
            container.innerHTML = '<canvas id="packetSizeCanvas" style="width: 100%; height: 400px;"></canvas>';
            const ctx = document.getElementById('packetSizeCanvas').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: historicalData.binLabels,
                    datasets: [{
                        label: 'Packet Count',
                        data: historicalData.binCounts,
                        backgroundColor: '#667eea',
                        borderColor: '#5a6fd8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Packet Size Range (bytes)' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Frequency' } }
                    },
                    plugins: {
                        title: { display: true, text: `Packet Size Distribution (${period})` }
                    }
                }
            });
        }
        
        function generatePacketSizeHistoricalData(period) {
            let baseCount;
            switch(period) {
                case '1min': baseCount = 50; break;
                case '5min': baseCount = 250; break;
                case '10min': baseCount = 500; break;
                case '30min': baseCount = 1500; break;
                default: baseCount = 500;
            }
            
            const bins = [64, 200, 400, 600, 800, 1000, 1200, 1400, 1500];
            const binLabels = ['64-200', '200-400', '400-600', '600-800', '800-1000', '1000-1200', '1200-1400', '1400+'];
            const binCounts = [];
            
            binLabels.forEach((label, index) => {
                const variation = Math.floor(Math.random() * 20) - 10;
                const count = Math.max(0, Math.floor(baseCount / 8) + variation);
                binCounts.push(count);
            });
            
            return { binLabels, binCounts };
        }
        
        function loadProtocolChart() {
            const container = document.getElementById('protocol-chart');
            if (!container) return;
            
            // Fetch data from API
            fetch('/api/protocol_distribution')
                .then(response => response.json())
                .then(data => {
                    // Create Chart.js protocol chart with dynamic data
                    container.innerHTML = '<canvas id="protocolCanvas" style="width: 100%; height: 400px;"></canvas>';
                    
                    const ctx = document.getElementById('protocolCanvas').getContext('2d');
                    
                    // Extract data from API response
                    const protocols = data.protocols || ['TCP', 'UDP', 'HTTPS', 'HTTP', 'DNS'];
                    const counts = data.counts || [45, 30, 15, 8, 2];
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: protocols,
                            datasets: [{
                                data: counts,
                                backgroundColor: [
                                    '#FF6384',
                                    '#36A2EB',
                                    '#FFCE56',
                                    '#4BC0C0',
                                    '#9966FF'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Protocol Distribution'
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    
                    console.log('Protocol chart loaded with dynamic data:', { protocols, counts });
                })
                .catch(error => {
                    console.error('Error loading protocol chart:', error);
                    // Fallback to static data if API fails
                    loadProtocolChartFallback(container);
                });
        }
        
        function loadProtocolChartFallback(container) {
            container.innerHTML = '<canvas id="protocolCanvas" style="width: 100%; height: 400px;"></canvas>';
            
            const ctx = document.getElementById('protocolCanvas').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['TCP', 'UDP', 'HTTPS', 'HTTP', 'DNS'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Protocol Distribution (No Data)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
                });
        }
        
        function loadAnomalyChart() {
            const container = document.getElementById('anomaly-chart');
            if (!container) return;
            
            // Fetch data from API
            fetch('/api/anomaly_summary')
                .then(response => response.json())
                .then(data => {
                    // Create Chart.js anomaly chart with dynamic data
                    container.innerHTML = '<canvas id="anomalyCanvas" style="width: 100%; height: 400px;"></canvas>';
                    
                    const ctx = document.getElementById('anomalyCanvas').getContext('2d');
                    
                    // Extract data from API response
                    const anomalies = data.anomalies || ['Normal', 'DDoS', 'Port Scan', 'Botnet', 'Data Exfiltration'];
                    const counts = data.counts || [95, 3, 2, 1, 1];
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: anomalies,
                            datasets: [{
                                label: 'Anomaly Count',
                                data: counts,
                                backgroundColor: [
                                    '#2ecc71', // Green for Normal
                                    '#e74c3c', // Red for DDoS
                                    '#f39c12', // Orange for Port Scan
                                    '#9b59b6', // Purple for Botnet
                                    '#e67e22'  // Dark orange for Data Exfiltration
                                ],
                                borderColor: [
                                    '#27ae60',
                                    '#c0392b',
                                    '#d68910',
                                    '#8e44ad',
                                    '#d35400'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Count'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Anomaly Detection Summary'
                                },
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                    
                    console.log('Anomaly chart loaded with dynamic data:', { anomalies, counts });
                })
                .catch(error => {
                    console.error('Error loading anomaly chart:', error);
                    // Fallback to static data if API fails
                    loadAnomalyChartFallback(container);
                });
        }
        
        function loadAnomalyChartFallback(container) {
            container.innerHTML = '<canvas id="anomalyCanvas" style="width: 100%; height: 400px;"></canvas>';
            
            const ctx = document.getElementById('anomalyCanvas').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Normal', 'DDoS', 'Port Scan', 'Botnet', 'Data Exfiltration'],
                    datasets: [{
                        label: 'Anomaly Count',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#e67e22'
                        ],
                        borderColor: [
                            '#27ae60', '#c0392b', '#d68910', '#8e44ad', '#d35400'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Count' }
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'Anomaly Detection Summary (No Data)' },
                        legend: { display: false }
                    }
                }
                });
        }
        
        function loadTimelineChart() {
            const container = document.getElementById('timeline-chart');
            if (!container) return;
            
            // Create Chart.js timeline chart
            container.innerHTML = '<canvas id="timelineCanvas" style="width: 100%; height: 400px;"></canvas>';
            
            // Generate timeline data
            const labels = [];
            const packetData = [];
            const sizeData = [];
            
            for (let i = 0; i < 20; i++) {
                const time = new Date();
                time.setMinutes(time.getMinutes() - (19 - i));
                labels.push(time.toLocaleTimeString());
                packetData.push(Math.floor(Math.random() * 50) + 10);
                sizeData.push(Math.floor(Math.random() * 1000) + 500);
            }
            
            const ctx = document.getElementById('timelineCanvas').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Packets/Second',
                        data: packetData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Packet Size (bytes)',
                        data: sizeData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Packets/Second'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Packet Size (bytes)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Real-time Network Traffic'
                        }
                    }
                }
                });
        }
        
        function loadTopIPsChart() {
            const container = document.getElementById('top-ips-chart');
            if (!container) return;
            
            // Fetch data from API
            fetch('/api/top_ips')
                .then(response => response.json())
                .then(data => {
                    // Create Chart.js top IPs chart with dynamic data
                    container.innerHTML = '<canvas id="topIPsCanvas" style="width: 100%; height: 400px;"></canvas>';
                    
                    const ctx = document.getElementById('topIPsCanvas').getContext('2d');
                    
                    // Extract data from API response
                    const ips = data.ips || [];
                    const sourceCounts = data.source_counts || [];
                    const destCounts = data.dest_counts || [];
                    
                    // If no data, show empty chart
                    if (ips.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;"><h4>No IP Data Available</h4><p>Start packet capture to see live IP statistics</p></div>';
                        return;
                    }
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ips,
                            datasets: [{
                                label: 'Source IPs',
                                data: sourceCounts,
                                backgroundColor: '#667eea',
                                borderColor: '#5a6fd8',
                                borderWidth: 1
                            }, {
                                label: 'Destination IPs',
                                data: destCounts,
                                backgroundColor: '#764ba2',
                                borderColor: '#6a4190',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'IP Addresses'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Traffic Volume'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Top IP Addresses'
                                }
                            }
                        }
                    });
                    
                    console.log('Top IPs chart loaded with dynamic data:', { ips, sourceCounts, destCounts });
                })
                .catch(error => {
                    console.error('Error loading top IPs chart:', error);
                    // Show error message
                    container.innerHTML = '<div style="text-align: center; padding: 50px; color: #e74c3c;"><h4>Error Loading IP Data</h4><p>Failed to fetch IP statistics</p></div>';
                });
        }
        
        function loadPacketSizeChart() {
            const container = document.getElementById('packet-size-chart');
            if (!container) return;
            
            // Create Chart.js packet size chart
            container.innerHTML = '<canvas id="packetSizeCanvas" style="width: 100%; height: 400px;"></canvas>';
            
            // Generate packet size data
            const packetSizes = [];
            for (let i = 0; i < 100; i++) {
                packetSizes.push(Math.floor(Math.random() * 1500) + 64);
            }
            
            // Create histogram data
            const bins = [64, 200, 400, 600, 800, 1000, 1200, 1400, 1500];
            const binLabels = ['64-200', '200-400', '400-600', '600-800', '800-1000', '1000-1200', '1200-1400', '1400+'];
            const binCounts = new Array(bins.length - 1).fill(0);
            
            packetSizes.forEach(size => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (size >= bins[i] && size < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });
            
            const ctx = document.getElementById('packetSizeCanvas').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Packet Count',
                        data: binCounts,
                        backgroundColor: '#667eea',
                        borderColor: '#5a6fd8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Packet Size Range (bytes)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Packet Size Distribution'
                        }
                    }
                }
                });
        }
        
        function loadHeatmap() {
            const container = document.getElementById('heatmap-chart');
            const timeWindow = document.getElementById('timeWindow').value;
            
            if (!container) return;
            
            // Fetch data from API
            fetch(`/api/network_heatmap?time_window=${timeWindow}`)
                .then(response => response.json())
                .then(data => {
                    // Create Chart.js heatmap with dynamic data
                    container.innerHTML = '<canvas id="heatmapCanvas" style="width: 100%; height: 400px;"></canvas>';
                    
                    const ctx = document.getElementById('heatmapCanvas').getContext('2d');
                    
                    // Extract data from API response
                    const protocols = data.protocols || ['TCP', 'UDP', 'HTTPS', 'HTTP', 'DNS'];
                    const timeLabels = data.time_labels || [];
                    const heatmapData = data.heatmap_data || [];
                    
                    // If no data, show empty chart
                    if (protocols.length === 0 || timeLabels.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;"><h4>No Heatmap Data Available</h4><p>Start packet capture to see live network activity</p></div>';
                        return;
                    }
                    
                    // Create datasets for each protocol
                    const datasets = protocols.map((protocol, index) => ({
                        label: protocol,
                        data: heatmapData[index] || [],
                        backgroundColor: `hsl(${index * 45}, 70%, 50%)`,
                        borderColor: `hsl(${index * 45}, 70%, 30%)`,
                        borderWidth: 1
                    }));
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: timeLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Activity Level'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Network Activity Heatmap'
                                }
                            }
                        }
                    });
                    
                    console.log('Heatmap loaded with dynamic data:', { protocols, timeLabels, heatmapData });
                })
                .catch(error => {
                    console.error('Error loading heatmap:', error);
                    // Show error message
                    container.innerHTML = '<div style="text-align: center; padding: 50px; color: #e74c3c;"><h4>Error Loading Heatmap</h4><p>Failed to fetch network activity data</p></div>';
                });
        }
        
        // Individual refresh functions
        function refreshProtocolChart() { loadProtocolChart(); }
        function refreshAnomalyChart() { loadAnomalyChart(); }
        function refreshTimelineChart() { loadTimelineChart(); }
        function refreshTopIPsChart() { loadTopIPsChart(); }
        function refreshPacketSizeChart() { loadPacketSizeChart(); }
        function refreshHeatmap() { loadHeatmap(); }
        
        // Load anomaly details
        function loadAnomalyDetails() {
            const loadingDiv = document.getElementById('anomaly-loading');
            const contentDiv = document.getElementById('anomaly-content');
            
            if (!loadingDiv || !contentDiv) {
                console.error('Anomaly elements not found');
                return;
            }
            
            console.log('🔄 Loading anomaly details...');
            
            // Show loading state
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            
            // First check if server is running, then fetch anomalies
            fetch('/api/test')
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Server is running:', data);
                    // Server is running, now fetch anomalies
                    return fetch('/api/anomaly_details');
                })
                .then(response => {
                    console.log('📡 Anomaly API response:', response.status);
                    console.log('📡 Response headers:', response.headers);
                    
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}. Expected JSON but got ${contentType || 'unknown'}`);
                    }
                    
                    return response.json();
                })
                .catch(error => {
                    console.log('❌ Server not running or error occurred, showing no data message');
                    // Server not running or error, show no data message
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    displayNoAnomalies();
                    return;
                })
                .then(data => {
                    console.log('📊 Anomaly data received:', data);
                    console.log('📊 Data type:', typeof data);
                    console.log('📊 Data keys:', data ? Object.keys(data) : 'null/undefined');
                    
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    
                    // Safe data access with validation
                    if (data && typeof data === 'object' && data.anomalies && Array.isArray(data.anomalies) && data.anomalies.length > 0) {
                        console.log(`✅ Found ${data.anomalies.length} anomalies`);
                        displayAnomalies(data.anomalies);
                    } else if (data && typeof data === 'object' && data.anomalies && Array.isArray(data.anomalies) && data.anomalies.length === 0) {
                        console.log('ℹ️ No anomalies found in response');
                        displayNoAnomalies();
                    } else {
                        console.log('⚠️ Invalid data format, showing no data message');
                        displayNoAnomalies();
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading anomaly details:', error);
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    
                    // Show error message when server is not available
                    console.log('🔄 Error occurred, showing no data message');
                    displayNoAnomalies();
                });
        }
        
        function displayAnomalies(anomalies) {
            const contentDiv = document.getElementById('anomaly-content');
            
            console.log('🔄 Displaying anomalies:', anomalies);
            console.log('🔄 Anomalies type:', typeof anomalies);
            console.log('🔄 Anomalies length:', anomalies ? anomalies.length : 'null/undefined');
            
            // Safe validation
            if (!anomalies || !Array.isArray(anomalies) || anomalies.length === 0) {
                console.log('⚠️ No valid anomalies to display');
                displayNoAnomalies();
                return;
            }
            
            let html = `
                <div class="anomaly-summary mb-4">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>${anomalies.length} Anomaly(ies) Detected</strong>
                    </div>
                </div>
                <div class="anomaly-list" style="max-height: 500px; overflow-y: auto;">
            `;
            
            // Sort anomalies by timestamp (newest first) with safe access
            try {
                anomalies.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA;
                });
            } catch (e) {
                console.log('⚠️ Error sorting anomalies:', e);
            }
            
            anomalies.forEach((anomaly, index) => {
                try {
                    const timestamp = anomaly.timestamp ? new Date(anomaly.timestamp).toLocaleString() : 'Unknown time';
                    const confidence = anomaly.confidence ? (anomaly.confidence * 100).toFixed(1) : '0.0';
                    const prediction = anomaly.prediction || 'Unknown';
                    const srcIp = anomaly.src_ip || 'Unknown';
                    const dstIp = anomaly.dst_ip || 'Unknown';
                    const protocol = anomaly.protocol || 'Unknown';
                    
                    html += `
                        <div class="anomaly-item" style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #e74c3c;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="anomaly-type" style="font-weight: bold; color: #e74c3c; margin-bottom: 5px;">${prediction}</div>
                                    <div class="anomaly-time" style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">${timestamp}</div>
                                    <small style="color: #6c757d;">${srcIp} → ${dstIp} (${protocol})</small>
                                </div>
                                <div>
                                    <span class="confidence-badge" style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">${confidence}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.log(`⚠️ Error processing anomaly ${index}:`, e);
                }
            });
            
            html += `</div>`;
            contentDiv.innerHTML = html;
            console.log('✅ Anomalies displayed successfully');
        }
        
        function displayNoAnomalies() {
            const contentDiv = document.getElementById('anomaly-content');
            contentDiv.innerHTML = `
                <div class="no-data text-center py-5">
                    <i class="fas fa-shield-alt" style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h5>No anomalies detected</h5>
                    <p class="text-muted">Your network is secure! No suspicious activities detected.</p>
                    <small class="text-muted">Real-time anomaly detection is active.</small>
                </div>
            `;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (globalAutoRefreshInterval) {
                clearInterval(globalAutoRefreshInterval);
            }
            if (socket) {
                socket.disconnect();
            }
        });
        
        // Handle time window change
        document.getElementById('timeWindow').addEventListener('change', function() {
            console.log('🔄 Time window changed, reloading heatmap...');
            // Ensure we're on the heatmap tab before loading
            const heatmapTab = document.getElementById('heatmap');
            if (heatmapTab && heatmapTab.classList.contains('active')) {
            loadHeatmap();
            } else {
                console.log('⚠️ Heatmap tab not active, heatmap will load when tab is activated');
            }
        });
        
        // Handle tab changes - simple approach
        document.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            
            setTimeout(() => {
                if (targetId === '#heatmap') {
                    loadHeatmap();
                } else if (targetId === '#overview') {
                    loadProtocolChart();
                    loadAnomalyChart();
                    // Force update statistics when switching to overview
                    setTimeout(updateSummaryStats, 200);
                } else if (targetId === '#traffic') {
                    loadTimelineChart();
                    loadTopIPsChart();
                    loadPacketSizeChart();
                } else if (targetId === '#anomalies') {
                    loadAnomalyDetails();
                }
            }, 100);
        });
        
        // Populate sample data function
    </script>
</body>
</html>
